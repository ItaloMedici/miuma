import { caregiverUseCases } from "@/use-cases/caregiver";
import { ImageResponse } from "next/og";

export const alt = "Cuidador de animais na Miuma";
export const size = {
  width: 1200,
  height: 630,
};

async function loadGoogleFont(font: string, text: string) {
  const url = `https://fonts.googleapis.com/css2?family=${font}&text=${encodeURIComponent(
    text
  )}`;
  const css = await (await fetch(url)).text();
  const resource = css.match(
    /src: url\((.+)\) format\('(opentype|truetype)'\)/
  );

  if (resource) {
    const response = await fetch(resource[1]);
    if (response.status == 200) {
      return await response.arrayBuffer();
    }
  }

  throw new Error("failed to load font data");
}

export default async function Image({
  params,
}: {
  params: Promise<{ profileId: string }>;
}) {
  const { profileId } = await params;

  if (!profileId) {
    return new Response("Missing profileId", { status: 400 });
  }

  const caregiver = await caregiverUseCases.getCaregiverByProfileId(profileId);

  if (!caregiver) {
    return new Response("Caregiver not found", { status: 404 });
  }

  const { profile } = caregiverUseCases.parseDataJson(caregiver);

  const location = `${profile.location.city}, ${profile.location.state}`;

  return new ImageResponse(
    (
      <div
        style={{
          width: `${size.width}px`,
          height: `${size.height}px`,
          background: "#fffefa",
          display: "flex",
          position: "relative",
          overflow: "hidden",
          border: "1px solid #f1f5f9",
          borderRadius: "24px",
          fontFamily: '"Stack Sans Text", sans-serif',
        }}
      >
        {/* Left Blurred Lime Blob */}
        <div
          style={{
            position: "absolute",
            top: "-10%",
            left: "-10%",
            width: "500px",
            height: "500px",
            background: "rgba(217, 249, 157, 0.5)",
            borderRadius: "9999px",
            filter: "blur(100px)",
            opacity: 0.6,
          }}
        />

        {/* LEFT CONTENT */}
        <div
          style={{
            width: "60%",
            height: "100%",
            padding: "64px 32px 64px 80px",
            display: "flex",
            flexDirection: "column",
            justifyContent: "space-between",
            zIndex: "10px",
          }}
        >
          {/* Logo */}
          <div
            style={{
              display: "flex",
            }}
          >
            <svg
              width="154"
              height="29"
              viewBox="0 0 154 29"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M3.71564 0.0300598C4.72623 -0.40246 8.04631 3.93963 9.5799 6.16483C14.9205 4.07202 20.5259 5.29276 22.6609 6.16483C23.1722 5.47313 24.4288 3.85498 25.367 2.91678C33.6668 7.3373 32.6747 16.8101 30.5096 22.3133C28.3444 27.8164 15.9843 30.7936 5.51935 24.659C-4.94518 18.5242 2.45264 0.571346 3.71564 0.0300598ZM15.0096 16.2039C14.8345 16.1728 14.619 16.1688 14.3885 16.2078C14.3374 16.2164 14.2746 16.2312 14.2098 16.2576C14.0833 16.2419 13.9509 16.2792 13.8494 16.3719C13.6657 16.5398 13.6524 16.8247 13.8201 17.0086C13.901 17.0971 14.0824 17.3151 14.1844 17.45C14.2019 17.4767 14.2195 17.5022 14.2342 17.5242L14.2332 17.5271C14.2179 17.5553 14.1902 17.6007 14.1453 17.6609C14.0554 17.7817 13.9042 17.9538 13.6678 18.1658C13.2574 18.5338 12.7939 18.6532 12.3026 18.7185C11.7706 18.6906 11.4588 18.5853 11.3074 18.5144C11.2865 18.5023 11.274 18.493 11.2596 18.4803C11.2383 18.4613 11.2026 18.4252 11.1424 18.3494C10.9876 18.1544 10.7037 18.1215 10.5086 18.2762C10.3135 18.431 10.2806 18.7148 10.4354 18.9099C10.5998 19.1171 10.7182 19.219 10.8787 19.3084L10.8895 19.3152L10.9012 19.3201C11.176 19.4531 11.624 19.5916 12.2996 19.6219L12.3387 19.6238L12.3768 19.6189C12.9448 19.5468 13.6441 19.3992 14.2703 18.8377C14.5387 18.597 14.7297 18.3846 14.8611 18.2097C15.0767 18.3223 15.3392 18.4614 15.5457 18.5633C15.6534 18.6163 15.8289 18.6789 16.0359 18.7478C16.2528 18.82 16.5349 18.9084 16.8738 19.0115L16.8924 19.0174L16.9119 19.0213C17.5809 19.1621 18.223 19.2158 18.7283 19.2078H18.7342L18.7401 19.2068C18.8335 19.2029 18.9276 19.1968 19.0184 19.1756C19.1215 19.1514 19.1999 19.1133 19.2664 19.076C19.483 18.9541 19.5595 18.6796 19.4383 18.4627C19.3165 18.2455 19.0422 18.1682 18.825 18.2898C18.818 18.2938 18.8123 18.2952 18.8094 18.2967C18.8057 18.2973 18.7986 18.2994 18.7879 18.3006C18.77 18.3024 18.7445 18.3039 18.7078 18.3055C18.2763 18.3117 17.711 18.2662 17.116 18.1424C16.7889 18.0428 16.5226 17.9594 16.3211 17.8924C16.1068 17.821 15.9891 17.7753 15.9451 17.7537C15.7707 17.6676 15.5528 17.5517 15.3592 17.451L15.3797 17.4168C15.3906 17.3996 15.4034 17.3804 15.4207 17.3553C15.4367 17.3321 15.4583 17.3011 15.4783 17.2703C15.5147 17.2144 15.5743 17.1168 15.6072 17.0008C15.6442 16.8698 15.6531 16.6856 15.5428 16.5076C15.4556 16.3672 15.3198 16.302 15.2625 16.2771C15.1837 16.243 15.0961 16.2193 15.0096 16.2039ZM8.86896 14.3826C8.64461 14.3933 8.36659 14.4188 8.17169 14.4978C7.86668 14.6217 7.51181 14.7864 7.27325 14.9715C7.12818 15.0842 7.00923 15.2058 6.92267 15.3103C6.84493 15.4042 6.76818 15.5145 6.72833 15.6082C6.63138 15.8372 6.73778 16.1025 6.96661 16.2C7.19568 16.2973 7.46077 16.1896 7.55841 15.9607C7.54935 15.9819 7.54632 15.9842 7.56134 15.9617C7.57342 15.9436 7.59258 15.9172 7.61798 15.8865C7.66957 15.8242 7.74108 15.7504 7.82599 15.6844C7.95885 15.5812 8.21271 15.4548 8.51056 15.3338C8.51056 15.3338 8.52113 15.3295 8.54474 15.324C8.56763 15.3187 8.5982 15.3127 8.63556 15.3074C8.71115 15.2967 8.80544 15.2891 8.91193 15.284C9.12513 15.2738 9.36837 15.2763 9.57892 15.284C9.80421 15.2922 10.0595 15.3298 10.2537 15.3699C10.376 15.4135 10.4847 15.4911 10.5779 15.5769L10.5789 15.5779C10.6305 15.6251 10.6695 15.6583 10.785 15.783C10.9539 15.9654 11.2389 15.9766 11.4217 15.8084C11.6044 15.6392 11.616 15.3535 11.4471 15.1707C11.3106 15.0233 11.2531 14.9712 11.1883 14.9119C11.0354 14.7714 10.8094 14.6017 10.5135 14.5056L10.492 14.4988L10.4686 14.4939C10.2371 14.4445 9.91422 14.3936 9.61115 14.3826C9.3858 14.3744 9.11596 14.3708 8.86896 14.3826ZM19.5262 14.1834C19.3465 14.1875 19.0851 14.1883 18.8231 14.2107C18.5618 14.2332 18.2601 14.2792 17.9891 14.3904C17.6447 14.532 17.3048 14.7057 17.1844 14.783C16.9751 14.9177 16.9142 15.1966 17.0486 15.406C17.1832 15.6153 17.4622 15.6758 17.6717 15.5418C17.7278 15.5059 18.0115 15.357 18.3318 15.2254C18.4784 15.1652 18.6742 15.1286 18.9002 15.1092C19.1253 15.0899 19.3433 15.0894 19.5467 15.0847C19.8565 15.0777 20.0624 15.1022 20.3045 15.1219C20.548 15.1417 20.8464 15.1817 21.1043 15.2283C21.233 15.2516 21.3473 15.2758 21.4363 15.2986C21.5216 15.3205 21.5596 15.3353 21.5662 15.3377L21.5818 15.3455C21.6629 15.385 21.7313 15.4213 21.7996 15.4666C21.8108 15.4749 21.8223 15.4847 21.8397 15.5008C21.8635 15.523 21.9002 15.5601 21.9588 15.6248C22.126 15.8091 22.412 15.822 22.5965 15.6551C22.7808 15.4877 22.7949 15.2028 22.6277 15.0183C22.4873 14.8635 22.4078 14.7933 22.324 14.7322L22.3104 14.7224L22.2205 14.6658C22.1334 14.613 22.0512 14.5704 21.9764 14.534C21.8799 14.4854 21.7597 14.4502 21.66 14.4246C21.5431 14.3946 21.4065 14.3663 21.2645 14.3406C20.9803 14.2893 20.653 14.2449 20.3777 14.2224C20.1581 14.2046 19.8946 14.175 19.5262 14.1834Z"
                fill="#3A3531"
              />
              <path
                d="M147.945 23.3865C147.945 22.6093 148.172 22.0265 148.69 21.6056C149.175 21.1846 149.92 20.958 150.956 20.958C151.96 20.958 152.705 21.1846 153.223 21.6056C153.741 22.0589 154 22.6417 154 23.3865C154 25.0378 152.964 25.8473 150.956 25.8473C148.949 25.8473 147.945 25.0378 147.945 23.3865Z"
                fill="#3A3531"
              />
              <path
                d="M146.571 24.7463C146.248 25.0054 145.794 25.2644 145.211 25.4911C144.629 25.7501 144.013 25.8473 143.366 25.8473C142.265 25.8473 141.455 25.5882 140.872 25.0378C140.29 24.4873 140.031 23.6778 140.031 22.5769C140.031 22.3826 140.063 21.9293 140.16 21.2817H139.48C139.092 22.8359 138.412 24.0016 137.44 24.7463C136.469 25.4911 135.141 25.8473 133.457 25.8473C131.709 25.8473 130.317 25.4263 129.345 24.5197C128.341 23.613 127.856 22.4474 127.856 20.9579C127.856 19.177 128.568 17.817 130.058 16.878C131.547 15.9713 133.522 15.4856 136.015 15.4856C136.987 15.4856 137.991 15.5504 139.092 15.6799V14.6438C139.092 12.7657 138.12 11.7943 136.177 11.7943C134.461 11.7943 133.393 12.7333 132.972 14.6114L128.6 13.7695C128.795 12.1505 129.637 10.8553 131.061 9.85153C132.486 8.88012 134.332 8.36205 136.663 8.36205C139.059 8.36205 140.905 8.91251 142.135 9.94867C143.366 11.0172 144.013 12.5067 144.013 14.4495V20.4398C144.013 20.9255 144.078 21.3141 144.272 21.5731C144.434 21.8645 144.661 21.994 144.952 21.994C145.211 21.994 145.47 21.8969 145.729 21.7026L146.571 24.7463ZM139.027 17.8494C138.444 17.7846 137.861 17.7523 137.343 17.7523C135.918 17.7523 134.85 18.0113 134.073 18.4646C133.296 18.9179 132.907 19.5979 132.907 20.5045C132.907 21.1522 133.101 21.6702 133.49 22.0264C133.878 22.3826 134.429 22.5445 135.109 22.5445C137.44 22.5445 138.768 20.9902 139.027 17.8494Z"
                fill="#3A3531"
              />
              <path
                d="M123.86 9.75439C124.767 10.6934 125.253 12.021 125.253 13.7695V25.3939H120.363V15.2914C120.363 14.3847 120.137 13.7047 119.748 13.1867C119.327 12.6686 118.712 12.4095 117.87 12.4095C116.705 12.4095 115.83 13.0248 115.183 14.2552C114.535 15.4856 114.211 17.2342 114.211 19.5655V25.3939H109.289V15.2914C109.289 14.3847 109.063 13.7047 108.642 13.1867C108.221 12.6686 107.573 12.4095 106.731 12.4095C105.598 12.4095 104.724 12.9924 104.076 14.1257C103.429 15.259 103.137 17.0075 103.137 19.4036V25.3939H98.2155V8.81537H102.263L102.652 13.0248H103.299C104.206 9.91629 106.019 8.36205 108.804 8.36205C110.326 8.36205 111.524 8.78299 112.398 9.56011C113.24 10.3696 113.726 11.5353 113.79 13.0248H114.47C115.28 9.91629 117.125 8.36205 119.975 8.36205C121.659 8.36205 122.954 8.84775 123.86 9.75439Z"
                fill="#3A3531"
              />
              <path
                d="M89.6829 8.81545H94.6047V25.394H90.5572L90.201 21.2818H89.5534C89.1001 22.6417 88.4201 23.7426 87.4811 24.5845C86.5097 25.4264 85.3116 25.8473 83.8545 25.8473C82.1383 25.8473 80.8108 25.394 79.9041 24.455C78.9651 23.5484 78.5118 22.1884 78.5118 20.4399V8.81545H83.4012V18.9828C83.4012 19.9542 83.6278 20.6989 84.0811 21.217C84.5345 21.7351 85.1821 21.9941 85.9916 21.9941C87.1249 21.9941 88.0315 21.3465 88.6791 20.0513C89.3267 18.7561 89.6829 17.04 89.6829 14.9029V8.81545Z"
                fill="#3A3531"
              />
              <path
                d="M69.5539 4.3146C69.5539 3.63462 69.7806 3.08416 70.2987 2.6956C70.7844 2.30704 71.5291 2.11276 72.5653 2.11276C73.5691 2.11276 74.3138 2.33942 74.8319 2.72798C75.35 3.11654 75.609 3.667 75.609 4.3146C75.609 5.80408 74.5728 6.54882 72.5653 6.54882C70.5577 6.54882 69.5539 5.80408 69.5539 4.3146ZM75.0262 25.394H70.1044V8.81543H75.0262V25.394Z"
                fill="#3A3531"
              />
              <path
                d="M65.235 9.75439C66.1416 10.6934 66.6273 12.021 66.6273 13.7695V25.3939H61.7379V15.2914C61.7379 14.3847 61.5113 13.7047 61.1227 13.1867C60.7018 12.6686 60.0865 12.4095 59.2447 12.4095C58.079 12.4095 57.2047 13.0248 56.5571 14.2552C55.9095 15.4856 55.5857 17.2342 55.5857 19.5655V25.3939H50.664V15.2914C50.664 14.3847 50.4373 13.7047 50.0164 13.1867C49.5954 12.6686 48.9478 12.4095 48.1059 12.4095C46.9726 12.4095 46.0984 12.9924 45.4508 14.1257C44.8032 15.259 44.5118 17.0075 44.5118 19.4036V25.3939H39.59V8.81537H43.6375L44.0261 13.0248H44.6737C45.5803 9.91629 47.3936 8.36205 50.1783 8.36205C51.7001 8.36205 52.8982 8.78299 53.7724 9.56011C54.6143 10.3696 55.1 11.5353 55.1648 13.0248H55.8448C56.6543 9.91629 58.4999 8.36205 61.3494 8.36205C63.0331 8.36205 64.3283 8.84775 65.235 9.75439Z"
                fill="#3A3531"
              />
            </svg>
          </div>

          {/* Main Content */}
          <div
            style={{ display: "flex", flexDirection: "column", gap: "24px" }}
          >
            <h1
              style={{
                fontSize: "72px",
                fontWeight: 600,
                lineHeight: 1.1,
                color: "#111",
              }}
            >
              {caregiver.name}
            </h1>

            {/* Description */}
            <p
              style={{
                fontSize: "22px",
                color: "#6b7280",
                maxWidth: "520px",
                lineHeight: 1.4,
                lineBreak: "anywhere",
                wordBreak: "break-word",
                lineClamp: 3,
                display: "-webkit-box",
                WebkitBoxOrient: "vertical",
                overflow: "hidden",
                WebkitLineClamp: 3,
              }}
            >
              {profile.shortBio}
            </p>

            <span>
              <div
                style={{
                  // padding: "8px 12px",
                  // background: "#fffefa",
                  // border: "1px solid #dfdace",
                  // borderRadius: "12px",
                  fontSize: "18px",
                  color: "#36342f",
                  fontWeight: 500,
                  display: "flex",
                  gap: "12px",
                  alignItems: "center",
                }}
              >
                <span style={{ color: "#93080f" }}>
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0" />
                    <circle cx="12" cy="10" r="3" />
                  </svg>
                </span>
                {location}
              </div>
            </span>
          </div>
        </div>

        {/* RIGHT IMAGE SECTION */}
        <div
          style={{
            width: "40%",
            height: "100%",
            position: "relative",
            display: "flex",
            background: "#f0fdf4",
          }}
        >
          <img
            alt="Caregiver profile"
            src={profile.caregiverImageUrl}
            style={{
              width: "100%",
              height: "100%",
              objectFit: "cover",
              padding: "24px",
              borderRadius: "48px",
            }}
          />

          {/* Floating badge */}
          <div
            style={{
              position: "absolute",
              bottom: "48px",
              left: "-48px",
              background: "white",
              padding: "18px 24px",
              borderRadius: "24px",
              display: "flex",
              alignItems: "center",
              gap: "20px",
              boxShadow: "0 8px 30px rgba(0,0,0,0.08)",
              border: "1px solid #f1f5f9",
            }}
          >
            <div style={{ display: "flex", gap: "16px", alignItems: "center" }}>
              <span style={{ color: "#9c86e9" }}>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <circle cx="11" cy="4" r="2" />
                  <circle cx="18" cy="8" r="2" />
                  <circle cx="20" cy="16" r="2" />
                  <path d="M9 10a5 5 0 0 1 5 5v3.5a3.5 3.5 0 0 1-6.84 1.045Q6.52 17.48 4.46 16.84A3.5 3.5 0 0 1 5.5 10Z" />
                </svg>
              </span>
              <div
                style={{
                  display: "flex",
                  fontSize: "18px",
                  fontWeight: 800,
                  color: "#36342f",
                }}
              >
                {`${profile.petsInCare.length} animais`}
              </div>
            </div>
          </div>

          {/* Heart badge */}
          <div
            style={{
              position: "absolute",
              top: "18x",
              right: "24px",
              padding: "12px",
              borderRadius: "20px",
              background: "rgba(255,255,255, 1)",
              border: "1px solid rgba(255,255,255,1)",
              transform: "rotate(12deg)",
              boxShadow: "0 6px 20px rgba(0,0,0,0.12)",
              display: "flex",
            }}
          >
            <svg width="32" height="32" fill="#f43f5e" viewBox="0 0 24 24">
              <path d="M12 21s-7-4.5-7-11a5 5 0 019-3 5 5 0 019 3c0 6.5-7 11-7 11z" />
            </svg>
          </div>
        </div>
      </div>
    ),
    {
      width: size.width,
      height: size.height,
      fonts: [
        {
          name: "Stack Sans Text",
          data: await loadGoogleFont(
            "Stack Sans Text",
            "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"
          ),
          weight: 800,
          style: "normal",
        },
      ],
    }
  );
}
